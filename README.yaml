name: "aws-spacelift"
# Canonical GitHub repo
github_repo: "cloudposse-terraform-components/aws-spacelift"
tags: []
# Categories of this project
categories: []
# License of this project
license: "APACHE2"
# Badges to display
badges:
  - name: Latest Release
    image: https://img.shields.io/github/release/cloudposse-terraform-components/aws-spacelift.svg?style=for-the-badge
    url: https://github.com/cloudposse-terraform-components/aws-spacelift/releases/latest
  - name: Slack Community
    image: https://slack.cloudposse.com/for-the-badge.svg
    url: https://slack.cloudposse.com
related:
  - name: "Cloud Posse Terraform Modules"
    description: Our collection of reusable Terraform modules used by our reference architectures.
    url: "https://docs.cloudposse.com/modules/"
  - name: "Atmos"
    description: "Atmos is like docker-compose but for your infrastructure"
    url: "https://atmos.tools"
contributors: [] # If included generates contribs
description: |-
  # This policy will automatically assign itself to stacks and is used to trigger stacks directly from the `cloudposse/github-action-atmos-affected-trigger-spacelift` GitHub action
  # This is only used if said GitHub action is set to trigger on "comments"
  "GIT_PUSH Plan Affected":
    type: GIT_PUSH
    labels:
      - autoattach:pr-comment-triggered
    body: |
      package spacelift

      # This policy runs whenever a comment is added to a pull request. It looks for the comment body to contain either:
      # /spacelift preview input.stack.id
      # /spacelift deploy input.stack.id
      #
      # If the comment matches those patterns it will queue a tracked run (deploy) or a proposed run (preview). In the case of
      # a proposed run, it will also cancel all of the other pending runs for the same branch.
      #
      # This is being used on conjunction with the GitHub actions `atmos-trigger-spacelift-feature-branch.yaml` and
      # `atmos-trigger-spacelift-main-branch.yaml` in .github/workflows to automatically trigger a preview or deploy run based
      # on the `atmos describe affected` output.

      track {
      	commented
      	contains(input.pull_request.comment, concat(" ", ["/spacelift", "deploy", input.stack.id]))
      }

      propose {
      	commented
      	contains(input.pull_request.comment, concat(" ", ["/spacelift", "preview", input.stack.id]))
      }

      # Ignore if the event is not a comment
      ignore {
      	not commented
      }

      # Ignore if the PR has a `spacelift-no-trigger` label
      ignore {
      	input.pull_request.labels[_] = "spacelift-no-trigger"
      }

      # Ignore if the PR is a draft and deesnt have a `spacelift-trigger` label
      ignore {
      	input.pull_request.draft
      	not has_spacelift_trigger_label
      }

      has_spacelift_trigger_label {
      	input.pull_request.labels[_] == "spacelift-trigger"
      }

      commented {
      	input.pull_request.action == "commented"
      }

      cancel[run.id] {
      	run := input.in_progress[_]
      	run.type == "PROPOSED"
      	run.state == "QUEUED"
      	run.branch == input.pull_request.head.branch
      }

      # This is a random sample of 10% of the runs
      sample {
        millis := round(input.request.timestamp_ns / 1e6)
        millis % 100 <= 10
      }
  ```

  This policy will automatically attach itself to _all_ components that have the `pr-comment-triggered` label, already
  defined in `stacks/orgs/NAMESPACE/_defaults.yaml` under `settings.spacelift.labels`.

  Next, create two new GitHub Action workflows:

  ```diff
  + .github/workflows/atmos-trigger-spacelift-feature-branch.yaml
  + .github/workflows/atmos-trigger-spacelift-main-branch.yaml
  ```

  The feature branch workflow will create a comment event in Spacelift to run a Proposed run for a given stack. Whereas
  the main branch workflow will create a comment event in Spacelift to run a Deploy run for those same stacks.

  #### Feature Branch

  ```yaml
  name: "Plan Affected Spacelift Stacks"

  on:
    pull_request:
      types:
        - opened
        - synchronize
        - reopened
      branches:
        - main

  jobs:
    context:
      runs-on: ["self-hosted"]
      steps:
        - name: Atmos Affected Stacks Trigger Spacelift
          uses: cloudposse/github-action-atmos-affected-trigger-spacelift@v1
          with:
            atmos-config-path: ./rootfs/usr/local/etc/atmos
            github-token: ${{ secrets.GITHUB_TOKEN }}
  ```

  This will add a GitHub comment such as:

  ```
  /spacelift preview plat-ue1-sandbox-foobar
  ```

  #### Main Branch

  ```yaml
  name: "Deploy Affected Spacelift Stacks"

  on:
    pull_request:
      types: [closed]
      branches:
        - main

  jobs:
    run:
      if: github.event.pull_request.merged == true
      runs-on: ["self-hosted"]
      steps:
        - name: Atmos Affected Stacks Trigger Spacelift
          uses: cloudposse/github-action-atmos-affected-trigger-spacelift@v1
          with:
            atmos-config-path: ./rootfs/usr/local/etc/atmos
            deploy: true
            github-token: ${{ secrets.GITHUB_TOKEN }}
            head-ref: ${{ github.sha }}~1
  ```

  This will add a GitHub comment such as:

  ```
  /spacelift deploy plat-ue1-sandbox-foobar
  ```
